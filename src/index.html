<!doctype html>
<html lang="en" class="h-100" data-bs-theme="auto">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="Diagrams as code for engineers">

    <base href="./">

    <link rel="icon" type="image/svg+xml" href="res/favicon/favicon.svg">
    <link rel="icon" type="image/png" href="res/favicon/favicon.png">

    <title>DrawTheNet.IO</title>

    <!-- JQuery -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.3/jquery.min.js"
        integrity="sha512-STof4xm1wgkfm7heWqFJVn58Hm3EtS31XFaagaa8VMReCXAkQnJZ+jEy8PCC/iT18dFy95WcExNHFTqLyp72eQ=="
        crossorigin="anonymous" referrerpolicy="no-referrer"></script>

    <!-- Bootstrap -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.3/css/bootstrap.min.css"
        integrity="sha512-jnSuA4Ss2PkkikSOLtYs8BlYIeeIK1h99ty4YfvRPAlzr377vr3CXDb7sb7eEEBYjDtcYj+AjBH3FLv5uSJuXg=="
        crossorigin="anonymous" referrerpolicy="no-referrer" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.3/js/bootstrap.bundle.min.js"
        integrity="sha512-7Pi/otdlbbCR+LnW+F7PwFcSDJOuUJB3OxtEHbg4vSMvzvJjde4Po1v4BR9Gdc9aXNUNFVUY+SK51wWT8WF0Gg=="
        crossorigin="anonymous" referrerpolicy="no-referrer"></script>

    <!-- D3 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.8.2/d3.min.js"
        integrity="sha512-oKI0pS1ut+mxQZdqnD3w9fqArLyILRsT3Dx0B+8RVEXzEk3aNK3J3pWlaGJ8MtTs1oiwyXDAH6hG6jy1sY0YqA=="
        crossorigin="anonymous" referrerpolicy="no-referrer"></script>

    <!-- Ace Editor -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.30.0/ace.min.js"
        integrity="sha512-lwC0l9krGlq0b9AQ2sQ5nftG8CYsJnp35DZrNmMH5i09vPo6ZeBLV0OEyCRhSByTk1l6sV6wMa7inlMjSsQAGA=="
        crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.30.0/worker-yaml.min.js"
        integrity="sha512-aPWbb5NOpduMdiLegfMiFpIBsuOpfR53PQTqcSkaEpuBrwarcGPmdFBqBM9xk17uv+THGPPu3ZiGzGoCScaDEw=="
        crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.30.0/mode-yaml.min.js"
        integrity="sha512-WcvQVyf7ECu3mkQRpaJJ2l05xJAIlFM1bscCbwduQBztxzoGUWqkAawsMdLr6tkD9ke4V6soIh6aufeAuW1ruw=="
        crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.30.0/theme-sqlserver.min.js"
        integrity="sha512-hoqwTsZLk0vYlY96Jgf76OqVR92L6S5ayr01RGvbz0uSJzU6hh3jYq5MM7cKNvncS7ddLly2EkfcvuFiwm948g=="
        crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.30.0/ext-language_tools.min.js"
        integrity="sha512-a648FNqnBRP0M40yGgwCoyBLYQVxpXxzqPhVPCwThDIKXFPyyJW0Um1QD1zmE+6euMlWdRS/rkcQrffXRt8+GQ=="
        crossorigin="anonymous" referrerpolicy="no-referrer"></script>

    <!-- Iconify -->
    <script src="https://code.iconify.design/iconify-icon/1.0.3/iconify-icon.min.js"></script>

    <!-- Fuse -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.6.2/fuse.min.js"
        integrity="sha512-Nqw1tH3mpavka9cQCc5zWWEZNfIPdOYyQFjlV1NvflEtQ0/XI6ZQ+H/D3YgJdqSUJlMLAPRj/oXlaHCFbFCjoQ=="
        crossorigin="anonymous" referrerpolicy="no-referrer"></script>

    <!-- JS-YAML -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/js-yaml/4.1.0/js-yaml.min.js"
        integrity="sha512-CSBhVREyzHAjAFfBlIBakjoRUKp5h7VSweP0InR/pAJyptH7peuhCsqAI/snV+TwZmXZqoUklpXp6R6wMnYf5Q=="
        crossorigin="anonymous" referrerpolicy="no-referrer"></script>

    <!-- jQuery toast -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-toast-plugin/1.3.2/jquery.toast.min.js"
        integrity="sha512-zlWWyZq71UMApAjih4WkaRpikgY9Bz1oXIW5G0fED4vk14JjGlQ1UmkGM392jEULP8jbNMiwLWdM8Z87Hu88Fw=="
        crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jquery-toast-plugin/1.3.2/jquery.toast.min.css"
        integrity="sha512-wJgJNTBBkLit7ymC6vvzM1EcSWeM9mmOu+1USHaRBbHkm6W9EgM0HY27+UtUaprntaYQJF75rc8gjxllKs5OIQ=="
        crossorigin="anonymous" referrerpolicy="no-referrer" />

    <!-- Showdown -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/showdown/2.1.0/showdown.min.js"
        integrity="sha512-LhccdVNGe2QMEfI3x4DVV3ckMRe36TfydKss6mJpdHjNFiV07dFpS2xzeZedptKZrwxfICJpez09iNioiSZ3hA=="
        crossorigin="anonymous" referrerpolicy="no-referrer"></script>

    <!-- Highlight.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js"
        integrity="sha512-bgHRAiTjGrzHzLyKOnpFvaEpGzJet3z4tZnXGjpsCcqOnAH6VGUx9frc5bcIhKTVLEiCO6vEhNAgx5jtLUYrfA=="
        crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <link rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/base16/atelier-cave-light.min.css"
        integrity="sha512-mb7hVnqouaHmHLJYLhdY+kUld4843IHJuRbVbhLXD41EJreUz0AeYU9t0XhwDFtnRVRvnLkbT/Xbjl1sajvpFQ=="
        crossorigin="anonymous" referrerpolicy="no-referrer" />
    <script
        src="https://cdnjs.cloudflare.com/ajax/libs/highlightjs-line-numbers.js/2.8.0/highlightjs-line-numbers.min.js"
        integrity="sha512-axd5V66bnXpNVQzm1c7u1M614TVRXXtouyWCE+eMYl8ALK8ePJEs96Xtx7VVrPBc0UraCn63U1+ARFI3ofW+aA=="
        crossorigin="anonymous" referrerpolicy="no-referrer"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/lz-string/1.4.4/lz-string.min.js"
        integrity="sha512-qoCTmFwBtCPvFhA+WAqatSOrghwpDhFHxwAGh+cppWonXbHA09nG1z5zi4/NGnp8dUhXiVrzA6EnKgJA+fyrpw=="
        crossorigin="anonymous" referrerpolicy="no-referrer"></script>

    <!-- Luxon -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/luxon/3.3.0/luxon.min.js"
        integrity="sha512-KKbQg5o92MwtJKR9sfm/HkREzfyzNMiKPIQ7i7SZOxwEdiNCm4Svayn2DBq7MKEdrqPJUOSIpy1v6PpFlCQ0YA=="
        crossorigin="anonymous" referrerpolicy="no-referrer"></script>


    <style>
        .nav-scroller .nav {
            display: flex;
            flex-wrap: nowrap;
            padding-bottom: 1rem;
            margin-top: -1px;
            overflow-x: auto;
            text-align: center;
            white-space: nowrap;
            -webkit-overflow-scrolling: touch;
        }

        main>.container-fluid {
            padding: 66px 0 0;
        }

        .heightTransition {

            transition-property: height;
            transition-duration: 0.5s;
            transition-timing-function: ease;

        }

        .h-0 {
            height: 0 !important;
        }

        .iconCard {
            height: 130px;
        }

        .iconCard img {
            height: 50px;
        }

        .iconCard .card-text {
            white-space: nowrap;
            font-size: x-small;
        }

        .iconCard .icon-name {
            text-overflow: ellipsis;
        }

        .iconCard {
            cursor: pointer;
        }
    </style>


</head>

<body class="d-flex flex-column h-100">
    <header>
        <!-- Fixed navbar -->
        <nav class="navbar navbar-expand-md navbar-dark fixed-top bg-dark">
            <div class="container-fluid">
                <div class="navbar-brand">

                    <div class="bg-light d-inline-block rounded">
                        <img src="res/logo.png" class="d-inline-block " alt="DrawTheNet.IO" width="40" height="40">
                    </div>
                    DrawTheNet.IO

                </div>
                <div class="btn-toolbar justify-content-between">

                    <div class="btn-group" role="group">
                        <button type="button" class="btn btn-danger" title="App's Help Guide">
                            <iconify-icon inline icon="ion:library-sharp"></iconify-icon> Library
                        </button>
                        <div class="btn-group" role="group">
                            <button type="button" class="btn btn-primary dropdown-toggle" data-bs-toggle="dropdown"
                                title="Complete icons sets on a single diagram">
                                Contact Sheets
                            </button>
                            <ul class="dropdown-menu" id="drpdwn-contact">
                            </ul>
                        </div>

                        <div class="btn-group" role="group">
                            <button type="button" class="btn btn-secondary dropdown-toggle" data-bs-toggle="dropdown"
                                aria-expanded="false">
                                Samples
                            </button>
                            <ul class="dropdown-menu" id="drpdwn-samples">
                            </ul>
                        </div>
                        <button type="button" class="btn btn-success" title="App's Help Guide">
                            <iconify-icon inline icon="oi:book"></iconify-icon> User Guide
                        </button>
                    </div>
                </div>
            </div>
        </nav>
    </header>

    <main class="h-100">
        <div class="container-fluid h-100">
            <div class="row h-100 gx-0">
                <div class="col-md-5 h-100">
                    <div class="row h-100 gx-0">
                        <div class="col-md-9 h-50 heightTransition" id="editorContainer">
                            <div id="editor" class="h-100"></div>
                        </div>
                        <div class="col-md-3 bg-dark-subtle h-50 p-2 heightTransition" id="centralButtonsContainer">
                            <div class="position-relative h-100">
                                <div class="position-absolute top-50 start-50 translate-middle w-100">
                                    <div class="d-grid mx-auto gap-2">
                                        <button class="btn btn-success" type="button" id="btnUpdate">
                                            <iconify-icon inline icon="zondicons:reload"></iconify-icon> Update
                                        </button>
                                        <div class="p-2 pb-1 text-black bg-success-subtle rounded fs-6 text-center"
                                            id="contAutoUpdate">
                                            <div class="form-check form-switch">
                                                <input class="form-check-input" type="checkbox" role="switch"
                                                    id="inpAutoUpdate" checked>
                                                <label class="form-check-label" for="inpAutoUpdate"
                                                    title="When ON, the preview will render automaticly after a couple of seconds of inactivity or on window resize.">
                                                    <iconify-icon inline icon="mdi:refresh-auto"></iconify-icon>
                                                    Auto-Update
                                                </label>
                                            </div>
                                        </div>
                                        <button type="button" class="btn btn-info" title="Icon Explorer"
                                            id="btnToggleIconExplorer">
                                            <iconify-icon inline
                                                icon="material-symbols-light:image-search"></iconify-icon>
                                            Icon
                                            Explorer
                                        </button>
                                    </div>
                                </div>
                                <div class="position-absolute bottom-0 start-50 translate-middle w-100 text-center">
                                    <p class="mb-0">Last update at : <span id="LastUpdateTime"></span></p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-12 h-50 bg-info-subtle" id="iconExplorerContainer">
                            <div class="row h-100 gx-0">
                                <div class="col-md-9 h-100">
                                    <div id="iconSearchResults" class="row gx-0 row-cols-8 h-100 overflow-auto">
                                        <h4 class="float-end">Type here to search for icons =></h4>
                                    </div>
                                </div>
                                <div class="col-md-3 bg-info h-100 p-2">
                                    <div class="bg-warning-subtle p-1 pt-2 rounded mb-3">
                                        <h4 class="text-center">Icon Explorer</h4>
                                    </div>
                                    <hr>
                                    <div class="form-floating mb-3">
                                        <input class="form-control form-control" type="text" placeholder="Search"
                                            id="inpSearchIcon">
                                        <label for="inpSearchIcon">Search</label>
                                    </div>

                                    <hr>
                                    <h5 class="text-center">Icon Sets</h5>

                                    <div id="iconSets" class="p-2">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-7 h-100">
                    <div class="h-100" id="preview"></div>
                </div>
            </div>

        </div>
    </main>

    <footer class="footer mt-auto py-3 bg-body-tertiary">
        <div class="container-fluid">
            <div class="btn-toolbar justify-content-between">
                <div class="btn-group" role="group">
                    <button type="button" class="btn btn-outline-primary" title="Export YAML code" id="btnSaveYAML">
                        <iconify-icon inline icon="bi:filetype-yml"></iconify-icon> Save Code
                    </button>
                </div>
                <div class="btn-group" role="group">
                    <button type="button" class="btn btn-primary" title="Export as PNG" id="btnSavePNG">
                        <iconify-icon inline icon="bi:filetype-png"></iconify-icon> PNG
                    </button>
                    <button type="button" class="btn btn-success" title="Export as SVG" id="btnSaveSVG">
                        <iconify-icon inline icon="bi:filetype-svg"></iconify-icon> SVG
                    </button>
                </div>
            </div>
        </div>
    </footer>

    <div class="modal fade" id="modHelp" data-bs-keyboard="false" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h1 class="modal-title fs-5" id="staticBackdropLabel">
                        <small>DrawTheNet.IO</small> - Help & Infos
                        <a href="./help.html" target="_blank" title="Open in a separate tab">
                            <iconify-icon inline icon="material-symbols:open-in-new"></iconify-icon>
                        </a>
                    </h1>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body p-2">
                    <iframe class="w-100" height="800px" src="./help.html"></iframe>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { Render as Renderer } from './res/js/render.js';
        import { ExportPNG, ExportSVG, LoadFonts } from './res/js/exporters.js';

        $(async function () {
            // =============================================
            // =============== Param Loading ===============
            // =============================================
            function genParamString(obj) {
                let urlParams = new URLSearchParams();

                urlParams.set("fullscreen", obj.fullscreen);
                urlParams.set("autosave", obj.autosave);
                urlParams.set("autoupdate", obj.autoupdate);
                urlParams.set("doc", LZString.compressToEncodedURIComponent(obj.doc));

                return urlParams.toString();
            }

            function parseParamString(paramString) {
                let urlParams = new URLSearchParams(paramString);

                let returnObj = {
                    "fullscreen": urlParams.get("fullscreen") === "true",
                    "autosave": urlParams.get("autosave") !== "false",
                    "autoupdate": urlParams.get("autoupdate") !== "false",
                    "doc": LZString.decompressFromEncodedURIComponent(urlParams.get("doc"))
                };
                return returnObj;
            }

            async function LoadParams() {
                let returnObj = parseParamString(window.location.hash.substring(1));

                if (returnObj.doc == null || returnObj.doc == "") {
                    let lastDoc = localStorage.getItem('lastDoc');
                    if (lastDoc != null) {
                        returnObj.doc = LZString.decompressFromEncodedURIComponent(lastDoc);
                    }
                    if (returnObj.doc == null || returnObj.doc == "") {
                        returnObj.doc = await fetch("./samples/welcome.yaml").then(r => r.text());
                    }
                }

                return returnObj;
            }

            function SetParams(params) {
                window.location.hash = "#" + genParamString(params)

                history.pushState(null, null, '#' + genParamString(params));
                /*
                            if (window.location.hash == '#' + urlParams.toString()) {
                                history.replaceState(null, null, '#');
                                history.replaceState(null, null, '#' + urlParams.toString());
                            }
                            else {
                                history.pushState(null, null, '#' + urlParams.toString());
                            }
                
                            */
            }

            // =============================================
            // ============== Editor & Hl.js ===============
            // =============================================

            // Highlight.js Init
            hljs.highlightAll();

            // Ace Editor Init & settings
            ace.config.set("basePath", "https://cdnjs.cloudflare.com/ajax/libs/ace/1.15.0/");

            let langTools = ace.require("ace/ext/language_tools");

            var editor = ace.edit("editor");
            editor.setTheme("ace/theme/sqlserver");
            editor.session.setMode("ace/mode/yaml");
            editor.setOption("tabSize", 2);
            editor.setOption("wrap", true);
            editor.setOption("enableBasicAutocompletion", true);
            editor.setShowPrintMargin(false);

            let completerKeywords = {
                document: [
                    "aspectRatio",
                    "margin",
                    "fill",
                    "watermark",
                    "renderRatio",
                    "fileTitlePrefix",
                    "schemasVersion"
                ],
                diagram: [
                    "columns",
                    "rows",
                    "invertY",
                    "gridLines",
                    "margin"
                ]

            }

            let completer = {
                getCompletions: function (editor, session, pos, prefix, callback) {

                    let lineStart = editor.session.getLine(pos.row).substr(0, pos.column);

                    let wsCount = lineStart.search(/\S|$/);

                    // case root of document
                    if (pos.column == 0) {
                        let rootKeywords = Object.keys(completerKeywords);

                        let completions = rootKeywords.map(keyword => {
                            return {
                                caption: keyword,
                                value: keyword,
                                meta: "root",
                                score: 1000
                            }
                        });


                    }
                }
            }

            langTools.setCompleters([completer]);


            // Data storage Init
            var Data = {};

            // =============================================
            // ======= Settings & session loading ==========
            // =============================================

            let params = await LoadParams();

            $('#inpAutoSave').prop('checked', params.autosave === true);
            $('#inpAutoUpdate').prop('checked', params.autoupdate === true);

            editor.setValue(params.doc, -1);

            $('#contAutoSave').on("click", function () {
                $('#inpAutoSave').prop("checked", !$('#inpAutoSave').is(":checked"));
            });
            $('#inpAutoSave').change(async function () {
                params = await LoadParams();

                params.autosave = $(this).is(":checked");

                SetParams(params);
            });
            $('#contAutoUpdate').on("click", function () {
                $('#inpAutoUpdate').prop("checked", !$('#inpAutoUpdate').is(":checked"));
            });
            $('#inpAutoUpdate').change(async function () {
                params = await LoadParams();

                params.autoupdate = $(this).is(":checked");

                SetParams(params);
            });

            // =============================================
            // ===============  Render =====================
            // =============================================
            let debounceRenderTimer;
            let lastDocument = null;
            let errorToast = null;

            function Render(maxDelay = 2000, keepZoom = true) {
                clearTimeout(debounceRenderTimer);
                debounceRenderTimer = setTimeout(async () => {
                    try {
                        $("#btnUpdate").prop("disabled", true);

                        let text = editor.session.getValue();

                        if (text === null || text === "" || text.trim() === "") {
                            return;
                        }

                        if ($("#inpAutoSave").is(":checked")) {
                            let params = await LoadParams();
                            params.doc = text;
                            SetParams(params);
                        }

                        let doc = jsyaml.load(text);
                        Renderer("#preview", doc, keepZoom);

                        if (errorToast !== null) {
                            errorToast.reset();
                            errorToast = null;
                        }

                        lastDocument = doc;
                    } catch (e) {
                        console.error(e);
                        errorToast = $.toast({
                            text: `<pre>${e.message}</pre>`,
                            heading: 'Error in document',
                            icon: 'error',
                            showHideTransition: 'slide',
                            allowToastClose: true,
                            hideAfter: false,
                            stack: false,
                            position: 'top-right',
                            loader: true
                        });
                        return;
                    }
                    finally {
                        $("#btnUpdate").prop("disabled", false);
                    }

                    LastUpdateTime.innerText = luxon.DateTime.now().toFormat("HH:mm:ss");
                }, maxDelay);
            }

            if ($('#inpAutoUpdate').is(":checked")) {
                Render(0);
            }

            $("#btnUpdate").click(function () {
                Render(0);
            });

            // Auto Update on change
            editor.session.on('change', function (delta) {
                if ($('#inpAutoUpdate').is(":checked")) {
                    Render();
                }

            });

            window.addEventListener("resize", (event) => {
                if ($('#inpAutoUpdate').is(":checked")) {
                    Render(50, false);
                }
            });



            // =============================================
            // ================== Samples ==================
            // =============================================
            fetch("./samples/samples.json")
                .then(response => response.json())
                .then(function (res) {
                    Object.keys(res).forEach(function (category) {
                        $("#drpdwn-samples").append(`<li class="bg-warning"><h6 class="dropdown-header">
                        <iconify-icon icon="ph:caret-down-fill"></iconify-icon>
                        ${category}
                        <iconify-icon icon="ph:caret-down-fill"></iconify-icon>
                        </h6></li>`);

                        Object.keys(res[category]).forEach(function (key) {
                            $("#drpdwn-samples").append(`<li file="${res[category][key]}"><a class="dropdown-item" href="#">${key}</a></li>`);
                        });
                    });
                });

            $("#drpdwn-samples, #drpdwn-contact").on("click", "li", function (event) {
                event.preventDefault();

                let fileName = $(this).attr("file");

                if (fileName === null || fileName === undefined) {
                    return;
                }

                fetch(`./samples/${fileName}`)
                    .then(response => response.text())
                    .then(function (res) {
                        editor.setValue(res, -1);
                    });

            });


            // =============================================
            // =============== Icons Search ================
            // =============================================
            $("#btnToggleIconExplorer").on("click", function (event) {
                event.preventDefault();

                console.log("Bip");

                if ($("#iconExplorerContainer").hasClass("h-0")) {
                    $("#iconExplorerContainer").addClass("h-50").removeClass("h-0");
                    $("#editorContainer, #centralButtonsContainer").addClass('h-50').removeClass('h-100');
                }
                else {
                    $("#iconExplorerContainer").addClass("h-0").removeClass("h-50");
                    $("#editorContainer, #centralButtonsContainer").addClass('h-100').removeClass('h-0');
                }
            });

            fetch("./res/icons/icons.json")
                .then(response => response.json())
                .then(function (res) {
                    // Contact Sheets
                    Object.keys(res).forEach(function (key) {
                        $("#drpdwn-contact").append(`<li file="${key.toLowerCase()}.yaml"><a class="dropdown-item" href="#">${key}</a></li>`);
                    });

                    // Icon Explorer
                    $("#iconSets").append(`<div class="form-check form-switch">
                                                <label class="form-check-label w-100" for="inpIconIconify">
                                                    <input class="form-check-input" type="checkbox" role="switch" id="inpIconIconify" set="Iconify" checked>
                                                    Iconify
                                                </label>
                                            </div>`);

                    Object.keys(res).forEach(function (key) {
                        $("#iconSets").append(`<div class="form-check form-switch">
                                                    <label class="form-check-label w-100" for="inpIcon${key}">
                                                        <input class="form-check-input" type="checkbox" role="switch" id="inpIcon${key}" set="${key}" checked>
                                                        ${key}
                                                    </label>
                                                </div>`);
                    });




                    Data.Icons = res;

                    let flattenIcons = [];

                    Object.keys(res).forEach(key => {
                        res[key].forEach(key2 => {
                            flattenIcons.push({ Icon: key2, Family: key });
                        });
                    });

                    Data.IconsFlat = flattenIcons;
                });


            let searchOptions = {
                includeScore: true,
                keys: ['Icon', 'Family']
            }


            function searchIcons(search) {
                let iconSets = [];

                $("#iconSets input:checked").each(function () {
                    iconSets.push($(this).attr("set"));
                });

                let allIcons = Data.IconsFlat.filter(icon => iconSets.includes(icon.Family));

                if (iconSets.includes("Iconify")) {
                    fetch("https://api.iconify.design/search?query=" + search)
                        .then(response => response.json())
                        .then(function (res) {
                            let iconifyIcons = res.icons.map(icon => {
                                return { Icon: icon, Family: "Iconify" };
                            });

                            let allIcons = Data.IconsFlat.concat(iconifyIcons);

                            let fuse = new Fuse(allIcons, searchOptions);

                            let searchRes = fuse.search(search);

                            RenderSearchResults(searchRes);
                        });
                }
                else {
                    let fuse = new Fuse(allIcons, searchOptions);

                    let searchRes = fuse.search(search);

                    RenderSearchResults(searchRes);
                }
            }

            function RenderSearchResults(searchRes) {
                $("#iconSearchResults").empty();
                if (searchRes.length == 0) {
                    $("#iconSearchResults").html("<div class='col-md-12'><h3>No results found</h3></div>");
                    return;
                }

                let maxSearchResult = 500;

                if (searchRes.length > maxSearchResult) {
                    searchRes.length = maxSearchResult;
                }

                searchRes.forEach(res => {
                    let icon = res.item.Icon;
                    let family = res.item.Family;

                    let url = `res/icons/${family.toLowerCase()}/${icon.toLowerCase()}.svg`;

                    if (family == "Iconify") {
                        url = `https://api.iconify.design/${icon.replace(":", "/")}.svg`;
                    }

                    $("#iconSearchResults").append(`
                    <div class="col p-1" >
                        <div class="card iconCard">
                            <div class="card-body p-2 bg-dark-subtle icon-full">
                                <img src="${url}" class="img-fluid w-100">
                            </div>
                            <div class="card-body p-2">
                                <p class="card-text icon-family mb-0"><small>${family}</small></p>
                                <p class="card-text icon-name mb-0"><small>${icon}</small></p>
                            </div>
                            
                        </div>
                    </div>
                    `);
                });
            }


            let debounceSearchIconTimer;
            $("#inpSearchIcon").on("input", function (event) {
                clearTimeout(debounceSearchIconTimer);
                debounceSearchIconTimer = setTimeout(() => searchIcons($("#inpSearchIcon").val()), 200);
            });

            $("#iconSets").on("change", "input", function (event) {
                clearTimeout(debounceSearchIconTimer);
                debounceSearchIconTimer = setTimeout(() => searchIcons($("#inpSearchIcon").val()), 0);
            });

            $("#iconSearchResults").on("click", ".icon-family", function (event) {
                event.preventDefault();

                let text = $(this).text().trim();

                navigator.clipboard.writeText(`"${text}"`).then(
                    () => {
                        $.toast({
                            heading: 'Icon family copied to clipboard',
                            icon: 'success',
                            showHideTransition: 'slide',
                            allowToastClose: true,
                            hideAfter: 2000,
                            position: 'bottom-right',
                            loader: true
                        });
                    },
                    () => {
                        $.toast({
                            heading: 'Icon family copying to clipboard failed. Please allow permission and try again',
                            icon: 'error',
                            showHideTransition: 'slide',
                            allowToastClose: true,
                            hideAfter: 5000,
                            position: 'bottom-right',
                            loader: true
                        });
                    }
                );
            });

            $("#iconSearchResults").on("click", ".icon-name", function (event) {
                event.preventDefault();

                let text = $(this).text().trim();

                navigator.clipboard.writeText(`"${text}"`).then(
                    () => {
                        $.toast({
                            heading: 'Icon name copied to clipboard',
                            icon: 'success',
                            showHideTransition: 'slide',
                            allowToastClose: true,
                            hideAfter: 2000,
                            position: 'bottom-right',
                            loader: true
                        });
                    },
                    () => {
                        $.toast({
                            heading: 'Icon name copying to clipboard failed. Please allow permission and try again',
                            icon: 'error',
                            showHideTransition: 'slide',
                            allowToastClose: true,
                            hideAfter: 5000,
                            position: 'bottom-right',
                            loader: true
                        });
                    }
                );
            });

            $("#iconSearchResults").on("click", ".icon-full", function (event) {
                event.preventDefault();

                let family = $(this).parents(".card").children(".icon-family").text().trim();
                let name = $(this).parents(".card").children(".icon-name").text().trim();

                navigator.clipboard.writeText(`iconFamily: "${family}", icon: "${name}"`).then(
                    () => {
                        $.toast({
                            heading: 'Icon name copied to clipboard',
                            icon: 'success',
                            showHideTransition: 'slide',
                            allowToastClose: true,
                            hideAfter: 2000,
                            position: 'bottom-right',
                            loader: true
                        });
                    },
                    () => {
                        $.toast({
                            heading: 'Icon name copying to clipboard failed. Please allow permission and try again',
                            icon: 'error',
                            showHideTransition: 'slide',
                            allowToastClose: true,
                            hideAfter: 5000,
                            position: 'bottom-right',
                            loader: true
                        });
                    }
                );
            });

            // =============================================
            // =============== FullScreen ==================
            // =============================================

            $("#btnFullscreen, #btnReduce").on("click", function (event) {
                event.preventDefault();
                params.fullscreen = !params.fullscreen;
                SetParams(params);
                applyFullscreen();
            });

            function applyFullscreen() {
                if (params.fullscreen) {
                    $("#topBar").hide();
                    $("#editorCol").hide();
                    $("#btnReduce").show();
                }
                else {
                    $("#topBar").show();
                    $("#editorCol").show();
                    $("#btnReduce").hide();
                }

                Render(0);
            }

            if (params.fullscreen) {
                applyFullscreen();
            }

            // =============================================
            // =========== Keyboard Shortcut ===============
            // =============================================

            $(document).on("keydown", function (event) {
                if (event.ctrlKey && event.key == "s") {
                    event.preventDefault();
                    $("#btnSave").click();
                }
                else if (event.ctrlKey && event.key == "Enter") {
                    event.preventDefault();
                    $("#btnFullscreen").click();
                }
            });

            // =============================================
            // =============== Local Save ==================
            // =============================================


            $("#btnSave").on("click", async function (event) {
                let text = editor.session.getValue();

                let params = await LoadParams();
                params.doc = text;
                SetParams(params);
            });

            // =============================================
            // ================= Exports ===================
            // =============================================

            // Preloading fonts for PNG export
            LoadFonts();

            function saveAs(blob, title) {
                let link = document.createElement("a");
                link.href = URL.createObjectURL(blob);
                link.download = title;
                link.click();
                URL.revokeObjectURL(link.href);
            }

            $("#btnSaveYAML").on("click", function (event) {
                event.preventDefault();

                if (lastDocument == null) return;

                let title = `${lastDocument.document.fileTitlePrefix}-${luxon.DateTime.now().toFormat("yyyy-MM-dd_HH-mm-ss")}.yml`

                let text = editor.session.getValue();
                let blob = new Blob([text], { type: "text/plain;charset=utf-8" });

                saveAs(blob, title);
            });


            $("#btnSaveSVG").on("click", async function (event) {
                event.preventDefault();

                if (lastDocument == null) return;

                let title = `${lastDocument.document.fileTitlePrefix}-${luxon.DateTime.now().toFormat("yyyy-MM-dd_HH-mm-ss")}.svg`

                let svg = (await ExportSVG($(".render")[0], lastDocument.document.renderRatio, !event.ctrlKey)).outerHTML;
                let blob = new Blob([svg], { type: "image/svg+xml;charset=utf-8" });

                saveAs(blob, title);
            });

            $("#btnSavePNG").on("click", async function (event) {
                event.preventDefault();

                if (lastDocument == null) return;

                let title = `${lastDocument.document.fileTitlePrefix}-${luxon.DateTime.now().toFormat("yyyy-MM-dd_HH-mm-ss")}.png`
                let blob = await ExportPNG($(".render")[0], lastDocument.document.renderRatio);

                saveAs(blob, title);

                return;
            });
        });
    </script>
</body>

</html>